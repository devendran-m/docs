"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[9681],{3905:function(e,t,n){n.d(t,{Zo:function(){return s},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},s=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),p=d(n),h=r,m=p["".concat(l,".").concat(h)]||p[h]||u[h]||o;return n?a.createElement(m,i(i({ref:t},s),{},{components:n})):a.createElement(m,i({ref:t},s))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=p;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,i[1]=c;for(var d=2;d<o;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},1054:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return c},metadata:function(){return d},toc:function(){return u}});var a=n(3117),r=n(102),o=(n(7294),n(3905)),i=["components"],c={},l="Advanced Optimization",d={unversionedId:"dapp-dev-guide/contract-dsl/advanced",id:"dapp-dev-guide/contract-dsl/advanced",title:"Advanced Optimization",description:"During advanced development, you may wish to optimize the output of the DSL for the blockchain once the base logic of your smart contract is in place. This requires digging into the actual code that the DSL generates, and here is where the cargo expand command becomes a useful tool.",source:"@site/source/docs/casper/dapp-dev-guide/contract-dsl/advanced.md",sourceDirName:"dapp-dev-guide/contract-dsl",slug:"/dapp-dev-guide/contract-dsl/advanced",permalink:"/dapp-dev-guide/contract-dsl/advanced",editUrl:"https://github.com/casper-network/docs/tree/main/source/docs/casper/dapp-dev-guide/contract-dsl/advanced.md",tags:[],version:"current",frontMatter:{}},s={},u=[{value:"Expanding the Macros",id:"expanding-the-macros",level:2},{value:"Building and Testing the Hello World Contract",id:"building-and-testing-the-hello-world-contract",level:2},{value:"Using the Makefile",id:"using-the-makefile",level:2}],p={toc:u};function h(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"advanced-optimization"},"Advanced Optimization"),(0,o.kt)("p",null,"During advanced development, you may wish to optimize the output of the DSL for the blockchain once the base logic of your smart contract is in place. This requires digging into the actual code that the DSL generates, and here is where the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/dtolnay/cargo-expand"},"cargo expand")," command becomes a useful tool."),(0,o.kt)("h2",{id:"expanding-the-macros"},"Expanding the Macros"),(0,o.kt)("p",null,"To see the code that the DSL generates, you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"cargo expand")," command. To install it, you can simply type the following in your terminal:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cargo install cargo-expand\n")),(0,o.kt)("p",null,"Once installed, you can go into your contract folder and type:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cargo expand\n")),(0,o.kt)("p",null,"To pipe it into a file for viewing, you can use this command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cargo expand | ./src/main-expanded.rs\n")),(0,o.kt)("p",null,"Once you view the output, you should see that the expanded file is much larger and more complex than the contract we viewed a moment ago. The DSL does a fantastic job of abstracting all this boilerplate code away from the development process."),(0,o.kt)("p",null,"You usually do not need to generate the expanded code. When the Rust compiler encounters each of the macros, it expands the code in place. The resultant expanded code is then compiled to a WASM binary, which can then be deployed to the blockchain."),(0,o.kt)("p",null,"Also, keep in mind that once you have expanded and changed the generated code, you should remove the macros from the project configuration before saving the changes and building it."),(0,o.kt)("h2",{id:"building-and-testing-the-hello-world-contract"},"Building and Testing the Hello World Contract"),(0,o.kt)("p",null,"By building and testing the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/casper-ecosystem/hello-world"},"Hello World")," contract, you can see how the DSL expands the macros."),(0,o.kt)("p",null,"The build process is identical to the one used in the ",(0,o.kt)("a",{parentName:"p",href:"/dapp-dev-guide/getting-started"},"Getting Started")," section, but here we do not have the ",(0,o.kt)("em",{parentName:"p"},"build.rs")," script that was used before. The following steps will help you manually build the contract."),(0,o.kt)("p",null,"First, we need to add the WASM target:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"rustup target add wasm32-unknown-unknown\n")),(0,o.kt)("p",null,"Next, build the contract into a WASM binary:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cargo build --release -p contract --target wasm32-unknown-unknown\n")),(0,o.kt)("p",null,"Then we can copy the WASM file into the ",(0,o.kt)("inlineCode",{parentName:"p"},"tests"),"\xa0folder and run the tests:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cp target/wasm32-unknown-unknown/release/contract.wasm tests/wasm\ncargo test -p tests\n")),(0,o.kt)("p",null,"If you successfully ran the two tests (",(0,o.kt)("inlineCode",{parentName:"p"},"should_run"),"\xa0and ",(0,o.kt)("inlineCode",{parentName:"p"},"should_update"),"), the DSL properly expanded your macros, built the binary, executed the contract, and called the update function. You should see an output similar to this if it worked correctly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Finished test [unoptimized + debuginfo] target(s) in 0.22s\n  Running target/debug/deps/tests-3b26d2abc1c949c4\n\nrunning 2 tests\ntest tests::should_run ... ok\ntest tests::should_update ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.71s\n")),(0,o.kt)("h2",{id:"using-the-makefile"},"Using the Makefile"),(0,o.kt)("p",null,"If you examine the repository contents, you'll see that there is a Makefile. This is an alternative to using a build script, as we did in the ",(0,o.kt)("a",{parentName:"p",href:"/dapp-dev-guide/getting-started"},"Getting Started guide"),". To duplicate the steps we took above, you would simply run the following two commands in your terminal:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"make prepare\nmake test\n")))}h.isMDXComponent=!0}}]);